<!DOCTYPE html>
<html lang="tr">
<head>
<link rel="icon" type="image/png" href="https://img.icons8.com/?size=100&id=E7kXDlAgCj90&format=png&color=000000">
  <meta charset="UTF-8">
  <title>Binance Coin Performans Tablosu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* Yeni Header Stilleri */
    .header-container {
  max-width: 1000px;
  margin: 0 auto;
  padding: 0 15px;
  position: relative; /* Bu sayede içindeki absolute pozisyonlu elementler buna göre konumlanır */
}
    .title-row {
      font-size: 16px;
      color: #00ffc3;
      text-shadow: 0 0 5px #00ffc3;
      padding: 10px 15px;
      margin: 0;
      text-align: left;
      border-bottom: 1px solid #00ffc355;
      position: relative;
    }
    .title-row::after {
      content: "";
      position: absolute;
      bottom: -1px;
      left: 0;
      width: 100%;
      height: 1px;
      background: linear-gradient(90deg, transparent, #00ffc3, transparent);
    }

    /* Modern Yükleme Çubuğu Stilleri */
    .loading-container {
      position: sticky;
      top: 10px;
      width: 300px;
      margin: 10px auto;
      background: rgba(15, 25, 35, 0.95);
      border-radius: 10px;
      border: 1px solid #00ffc355;
      z-index: 1000;
      transition: opacity 0.5s;
      box-shadow: 0 0 10px rgba(0, 255, 195, 0.3);
    }
    
    .loading-bar {
      width: 100%;
      height: 4px;
      background-color: #1c2c3c;
      border-radius: 10px;
      overflow: hidden;
      position: relative;
    }
    
    .progress {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #00ffc3, #00ffaa);
      border-radius: 10px;
      transition: width 0.3s ease;
      position: relative;
    }
    
    .progress::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
    90deg,
    rgba(255, 255, 255, 0) 0%,
    rgba(255, 255, 255, 0.8) 50%,
    rgba(255, 255, 255, 0) 100%
  );
  animation: shimmer 1s infinite;

    }
    
    .progress-text {
 display: none; /* Yazıyı tamamen gizledik */
}
    
    @keyframes shimmer {
      0% {
        transform: translateX(-100%);
      }
      100% {
        transform: translateX(100%);
      }
    }

    /* LED Panel Stilleri */
    .led-panel-container {
      position: absolute;
      left: 325px;
      top: 4px;
      z-index: 1;
      background: transparent;
      border: none;
      padding: 0;
      margin: 0;
    }
    
    .led-panel {
      display: flex;
      background-color: transparent;
      padding: 0;
      gap: 8px;
    }

    .led-char {
      display: grid;
      grid-template-columns: repeat(5, 2px);
      grid-template-rows: repeat(7, 2px);
      gap: 2px;
    }

    .led-dot {
      width: 2px;
      height: 2px;
      border-radius: 50%;
      background-color: #111;
      box-shadow: 0 0 1px #0ff;
      transition: background-color 0.3s, box-shadow 0.3s;
    }

    .led-on {
      background-color: #0ff;
      box-shadow: 0 0 4px #0ff;
    }

    .led-on.up {
      background-color: #0f0;
      box-shadow: 0 0 4px #0f0;
    }

    .led-on.down {
      background-color: #f00;
      box-shadow: 0 0 4px #f00;
    }

    .led-slide-up {
      animation: slideUp 0.4s ease;
    }

    .led-slide-down {
      animation: slideDown 0.4s ease;
    }

    @keyframes slideUp {
      from { transform: translateY(10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @keyframes slideDown {
      from { transform: translateY(-10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .led-strip {
      display: flex;
      gap: 8px;
    }

    /* Orijinal Stillerin Tamamı */
    .portfolio-modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(15, 25, 35, 0.98);
      border: 1px solid #00ffc3;
      border-radius: 10px;
      padding: 20px;
      width: 450px;
      max-width: 90%;
      z-index: 1000;
      box-shadow: 0 0 20px rgba(0, 255, 195, 0.3);
    }
    .portfolio-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .portfolio-close {
      cursor: pointer;
      color: #00ffc3;
      font-size: 24px;
    }
    #portfolioForm {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    #coinSelect, #amountInput {
      flex: 1;
      padding: 5px;
      background: #1c2c3c;
      border: 1px solid #00ffc3;
      color: #e0e0e0;
      border-radius: 3px;
    }
    .portfolio-list {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 15px;
    }
    .portfolio-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      border-bottom: 1px solid #00ffc322;
    }
    .portfolio-item-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .delete-portfolio-item {
      color: #ff4d4d;
      cursor: pointer;
      font-weight: bold;
      padding: 0 5px;
    }
    .delete-portfolio-item:hover {
      color: #ff0000;
    }
    .portfolio-total {
      text-align: right;
      font-weight: bold;
      color: #00ffc3;
    }
.portfolio-button {
  background: #00ffc3;
  color: #0f2027;
  border: none;
  padding: 8px 15px;
  border-radius: 5px;
  cursor: pointer;
  font-family: 'Roboto Mono', monospace;
  font-weight: bold;
  position: absolute;
  right: 20px;
  top: 4px; /* Bu değeri daha küçük bir sayıyla değiştirin */
  z-index: 1;
}
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #e0e0e0;
      padding: 10px;
      text-align: center;
      overflow-x: hidden;
    }
    .table-container {
      display: flex;
      justify-content: center;
      margin-top: 10px;
    }
    .table-wrapper {
      background: rgba(15, 25, 35, 0.95);
      border-radius: 10px;
      box-shadow: 0 0 15px #00ffcc66, inset 0 0 10px rgba(0, 255, 195, 0.2);
      max-width: 1000px;
      width: 100%;
      overflow-x: auto;
      max-height: 500px;
      border: 1px solid #00ffc3;
      position: relative;
    }
    .table-wrapper::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
        135deg,
        rgba(0, 255, 195, 0.05) 0%,
        rgba(0, 255, 195, 0) 20%,
        rgba(0, 255, 195, 0) 80%,
        rgba(0, 255, 195, 0.05) 100%
      );
      pointer-events: none;
      z-index: 1;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      table-layout: fixed;
      font-size: 13px;
    }
    thead th:nth-child(1), tbody td:nth-child(1) { width: 30px; }
    thead th:nth-child(2), tbody td:nth-child(2) { width: 40px; }
    thead th:nth-child(3), tbody td:nth-child(3) { width: 90px; }
    thead th:nth-child(4), tbody td:nth-child(4) { width: 90px; }
    thead th:nth-child(5), tbody td:nth-child(5) { width: 90px; }
    thead th:nth-child(6), tbody td:nth-child(6) { width: 70px; }
    thead th:nth-child(7), tbody td:nth-child(7) { width: 70px; }
    thead th:nth-child(8), tbody td:nth-child(8) { width: 60px; }
    thead th:nth-child(9), tbody td:nth-child(9) { width: 60px; }
    thead th:nth-child(10), tbody td:nth-child(10) { width: 60px; }
    thead th:nth-child(3), tbody td:nth-child(3) {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    thead th {
      background: #00ffc3;
      color: #0f2027;
      font-size: 14px;
      font-weight: bold;
      font-family: 'Roboto Mono', monospace;
      position: sticky;
      top: 0;
      z-index: 2;
      padding: 8px 5px;
      border-right: 1px solid #088f8f;
      cursor: pointer;
    }
    thead th:first-child { cursor: default; }
    thead th:last-child { border-right: none; }
    tbody td {
      padding: 8px 10px;
      text-align: center;
      border: 1px solid #00ffc322;
      font-size: 13px;
      transition: color 0.1s ease;
    }
    td.green { color: #00ff00; font-weight: bold; text-shadow: 0 0 5px rgba(0, 255, 0, 0.3); }
    td.red   { color: #ff4d4d; font-weight: bold; text-shadow: 0 0 5px rgba(255, 77, 77, 0.3); }
    td.coin-name {
      font-weight: bold;
      text-align: left;
      padding-left: 8px;
      color: #ffffff;
      overflow: hidden;
      text-overflow: ellipsis;
      position: relative;
    }
    td.coin-name a {
      color: inherit;
      text-decoration: none;
    }
    td.coin-name a:hover {
      text-decoration: underline;
      color: #00ffc3;
    }
    .chart-emoji {
      float: right;
      margin-left: 5px;
      text-decoration: none !important;
    }
    .chart-emoji:hover {
      color: #00ffc3 !important;
      text-decoration: none !important;
    }
    .search-input {
      margin-top: 2px;
      padding: 3px;
      font-size: 11px;
      width: 70px;
      border: 1px solid #00ffc3;
      border-radius: 3px;
      background: #1c2c3c;
      color: #e0e0e0;
    }
    .dip-input {
      margin-top: 3px;
      padding: 4px;
      font-size: 12px;
      width: 40px;
      border: 1px solid #00ffc3;
      border-radius: 3px;
      background: #1c2c3c;
      color: #e0e0e0;
    }
    .dip-multiplier-select, .rsi-select, .currency-select {
      margin-top: 3px;
      padding: 4px;
      font-size: 12px;
      width: 70px;
      border: 1px solid #00ffc3;
      border-radius: 3px;
      background: #1c2c3c;
      color: #e0e0e0;
      cursor: pointer;
    }
    
    /* Sayaç için yeni stiller */
    .counter-container {
      background: rgba(15, 25, 35, 0.95);
      border-radius: 5px;
      box-shadow: 0 0 15px #00ffcc66, inset 0 0 10px rgba(0, 255, 195, 0.2);
      border: 1px solid #00ffc3;
      padding: 5px 10px;
      display: inline-block;
      position: absolute;
      left: 750px;
      top: 2px;
      z-index: 1;
    }

    /* Yeni eklenen favori butonları için stil */
    .favorite-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
      margin-bottom: 15px;
    }
    
    .favorite-button {
      background: #00ffc3;
      color: #0f2027;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-family: 'Roboto Mono', monospace;
      font-weight: bold;
    }
    
    .favorite-button:hover {
      background: #00e6b8;
    }
    
    @media (max-width: 768px) { table { font-size: 12px; } }
  </style>
</head>
<body>

<!-- Modern Yükleme Çubuğu -->
<div class="loading-container" id="loadingContainer">
  <div class="loading-bar">
    <div class="progress" id="progressBar"></div>
    <div class="progress-text" id="progressText">%0 Yüklendi</div>
  </div>
</div>

<!-- Yeni Başlık Satırı -->
<div class="header-container">
  <div class="title-row">🚀 Binance Coin Performans Tablosu</div>
  <!-- LED Panel -->
  <div class="led-panel-container">
    <div class="led-panel">
      <div class="led-strip" id="ledLabel"></div>
      <div class="led-strip" id="ledPrice"></div>
    </div>
  </div>
  <!-- Sayaç Container -->
  <div class="counter-container">
    <div id="sfcjbq4sxejyjwcnf4jug2m4n1qcghq43wg"></div>
    <script type="text/javascript" src="https://counter4.optistats.ovh/private/counter.js?c=jbq4sxejyjwcnf4jug2m4n1qcghq43wg&down=async" async></script>
  </div>
  <!-- Portföy Butonu -->
  <button class="portfolio-button" onclick="togglePortfolio()">Portföy</button>
</div>

<!-- Tablo Container -->
<div class="table-container">
  <div class="table-wrapper">
    <table id="coinTable">
      <thead>
        <tr>
          <th>★<br>
            <input type="checkbox" id="favoriteFilter" 
                   onclick="event.stopPropagation()"
                   onchange="filterFavorites()">
          </th>
          <th>#</th>
          <th onclick="sortTable(2)">
            Coin<br>
            <input id="coinSearch" type="text" class="search-input" placeholder="Ara..." onkeyup="searchCoin()" onclick="event.stopPropagation()">
          </th>
          <th onclick="sortTable(3)">
            Aylık Dip Fiyatı<br>
            <select id="dipMonths" class="dip-multiplier-select" onchange="updateTable()" onclick="event.stopPropagation()">
  <option value="1">1 Ay</option>
  <option value="3">3 Ay</option>
  <option value="6">6 Ay</option>
  <option value="9">9 Ay</option>
  <option value="12" selected>12 Ay</option>
  <option value="18">18 Ay</option>
  <option value="24">24 Ay</option>
  <option value="36">36 Ay</option>
  <option value="48">48 Ay</option>
  <option value="120">120 Ay</option>
</select>
          </th>
<th onclick="sortTable(4)">
  Fiyat<br>
  <select id="currencySelect" class="currency-select" onchange="updateCurrency()" onclick="event.stopPropagation()">
    <option value="USD">USD</option>
    <option value="TRY">TRY</option>
    <option value="EUR">EUR</option>
    <option value="GBP">GBP</option>
    <option value="JPY">JPY</option>
    <option value="CNY">CNY</option>
  </select>
</th>
          <th onclick="sortTable(5)">
            Dipten Artış<br>
            <select id="dipMultiplier" class="dip-multiplier-select" onchange="filterByDipMultiplier()" onclick="event.stopPropagation()">
              <option value="0">Tümü</option>
              <option value="5">0x-5x</option>
              <option value="10">5x-10x</option>
              <option value="20">10x-20x</option>
              <option value="50">20x-50x</option>
              <option value="200">50x-200x</option>
              <option value="201">200x+</option>
            </select>
          </th>
<th onclick="sortTable(6)">
  24s Değişim<br>
  <input type="checkbox" class="filter-checkbox" 
         id="autoSortCheckbox" 
         onclick="event.stopPropagation()">
</th>
          <th onclick="sortTable(7)">
            A‑RSI<br>
            <select id="arsiFilter" class="rsi-select" onchange="filterByRSI('a-rsi', this.value)" onclick="event.stopPropagation()">
              <option value="0">Tümü</option>
              <option value="1-30">1-30</option>
              <option value="30-40">30-40</option>
              <option value="40-50">40-50</option>
              <option value="50-60">50-60</option>
              <option value="60-70">60-70</option>
              <option value="70-80">70-80</option>
              <option value="80-90">80-90</option>
              <option value="90+">90+</option>
            </select>
          </th>
          <th onclick="sortTable(8)">
            H‑RSI<br>
            <select id="hrsiFilter" class="rsi-select" onchange="filterByRSI('h-rsi', this.value)" onclick="event.stopPropagation()">
              <option value="0">Tümü</option>
              <option value="1-30">1-30</option>
              <option value="30-40">30-40</option>
              <option value="40-50">40-50</option>
              <option value="50-60">50-60</option>
              <option value="60-70">60-70</option>
              <option value="70-80">70-80</option>
              <option value="80-90">80-90</option>
              <option value="90+">90+</option>
            </select>
          </th>
          <th onclick="sortTable(9)">
            G‑RSI<br>
            <select id="grsiFilter" class="rsi-select" onchange="filterByRSI('g-rsi', this.value)" onclick="event.stopPropagation()">
              <option value="0">Tümü</option>
              <option value="1-30">1-30</option>
              <option value="30-40">30-40</option>
              <option value="40-50">40-50</option>
              <option value="50-60">50-60</option>
              <option value="60-70">60-70</option>
              <option value="70-80">70-80</option>
              <option value="80-90">80-90</option>
              <option value="90+">90+</option>
            </select>
          </th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- Yeni eklenen favori butonları -->
<div class="favorite-buttons">
  <button class="favorite-button" onclick="downloadFavorites()">Favorileri İndir</button>
  <button class="favorite-button" onclick="document.getElementById('favoriteFileInput').click()">Favorileri Yükle</button>
  <input type="file" id="favoriteFileInput" accept=".json" style="display: none;" onchange="uploadFavorites(this)">
<button class="favorite-button" onclick="window.open('https://kriptokat.github.io/coinanaliz-light/', '_blank')">4S-S RSI</button>
<button class="favorite-button" onclick="window.open('https://kriptokat.github.io/coinanaliz/ATH.html', '_blank')">ATH</button>
</div>

<!-- Portföy Modal -->
<div class="portfolio-modal" id="portfolioModal">
  <div class="portfolio-header">
    <h3>Portföy Yönetimi</h3>
    <span class="portfolio-close" onclick="togglePortfolio()">&times;</span>
  </div>
  <form id="portfolioForm" onsubmit="addToPortfolio(event)">
    <select id="coinSelect" required>
      <option value="" disabled selected>Coin Seç</option>
    </select>
    <input type="number" id="amountInput" step="0.001" placeholder="Miktar" required>
    <button type="submit">Ekle</button>
  </form>
  <div class="portfolio-list" id="portfolioList"></div>
  <div class="portfolio-total">
    Toplam Değer: <span id="portfolioTotal">0</span> <span id="portfolioCurrency">USD</span>
  </div>
</div>

<script>
  // LED Panel Fonksiyonları
  const ledAlphabet = {
    'A': ["01110","10001","10001","11111","10001","10001","10001"],
    'B': ["11110","10001","10001","11110","10001","10001","11110"],
    'C': ["01110","10001","10000","10000","10000","10001","01110"],
    'D': ["11110","10001","10001","10001","10001","10001","11110"],
    'E': ["11111","10000","10000","11110","10000","10000","11111"],
    'F': ["11111","10000","10000","11110","10000","10000","10000"],
    'G': ["01110","10001","10000","10111","10001","10001","01111"],
    'H': ["10001","10001","10001","11111","10001","10001","10001"],
    'I': ["01110","00100","00100","00100","00100","00100","01110"],
    'K': ["10001","10010","10100","11000","10100","10010","10001"],
    'L': ["10000","10000","10000","10000","10000","10000","11111"],
    'N': ["10001","11001","10101","10011","10001","10001","10001"],
    'O': ["01110","10001","10001","10001","10001","10001","01110"],
    'P': ["11110","10001","10001","11110","10000","10000","10000"],
    'R': ["11110","10001","10001","11110","10100","10010","10001"],
    'S': ["01111","10000","10000","01110","00001","00001","11110"],
    'T': ["11111","00100","00100","00100","00100","00100","00100"],
    'U': ["10001","10001","10001","10001","10001","10001","01110"],
    'V': ["10001","10001","10001","10001","10001","01010","00100"],
    'Y': ["10001","10001","01010","00100","00100","00100","00100"],
    ':': ["00000","00100","00000","00000","00100","00000","00000"],
    '.': ["00000","00000","00000","00000","00000","00100","00100"],
    '0': ["01110","10001","10011","10101","11001","10001","01110"],
    '1': ["00100","01100","00100","00100","00100","00100","01110"],
    '2': ["01110","10001","00001","00010","00100","01000","11111"],
    '3': ["11110","00001","00001","00110","00001","00001","11110"],
    '4': ["00010","00110","01010","10010","11111","00010","00010"],
    '5': ["11111","10000","11110","00001","00001","10001","01110"],
    '6': ["01110","10000","11110","10001","10001","10001","01110"],
    '7': ["11111","00001","00010","00100","01000","01000","01000"],
    '8': ["01110","10001","10001","01110","10001","10001","01110"],
    '9': ["01110","10001","10001","01111","00001","00001","01110"],
    ' ': ["00000","00000","00000","00000","00000","00000","00000"]
  };

  const ledLabelEl = document.getElementById("ledLabel");
  const ledPriceEl = document.getElementById("ledPrice");
  let previousLedPrice = null;
  let previousLedPriceText = "";

  function renderLedText(container, text, prevText = '', direction = '') {
    container.innerHTML = '';
    const upperText = text.toUpperCase();

    for (let i = 0; i < upperText.length; i++) {
      const char = upperText[i];
      const prevChar = prevText[i];
      const matrix = ledAlphabet[char] || ledAlphabet[' '];
      const prevMatrix = ledAlphabet[prevChar] || [];

      const charDiv = document.createElement("div");
      charDiv.className = "led-char";

      matrix.forEach((row, rowIndex) => {
        [...row].forEach((dot, colIndex) => {
          const dotDiv = document.createElement("div");
          const isOn = dot === '1';
          const wasOn = prevMatrix[rowIndex] && prevMatrix[rowIndex][colIndex] === '1';
          dotDiv.className = "led-dot";
          if (isOn) {
            dotDiv.classList.add("led-on");
            if (!wasOn && direction) {
              dotDiv.classList.add(direction === "up" ? "led-slide-up" : "led-slide-down");
            }
            if (direction) dotDiv.classList.add(direction);
          }
          charDiv.appendChild(dotDiv);
        });
      });

      container.appendChild(charDiv);
    }
  }

  async function scrambleLedText(text, container) {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789:';
    let result = Array(text.length).fill('');
    const delay = ms => new Promise(r => setTimeout(r, ms));

    for (let i = 0; i < text.length; i++) {
      for (let t = 0; t < 4; t++) {
        result[i] = chars[Math.floor(Math.random() * chars.length)];
        renderLedText(container, result.join(''));
        await delay(40);
      }
      result[i] = text[i];
      renderLedText(container, result.join(''));
      await delay(80);
    }
  }

  async function ledMainLoop() {
    await scrambleLedText("BITCOIN:", ledLabelEl);

    while (true) {
      let text = "";
      let direction = "up";

      try {
        const res = await fetch("https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT");
        const data = await res.json();
        const price = Math.floor(parseFloat(data.price));
        text = price.toString();

        if (previousLedPrice !== null) {
          direction = price > previousLedPrice ? "up" : price < previousLedPrice ? "down" : '';
        }

        previousLedPrice = price;
      } catch {
        text = "ERR";
      }

      renderLedText(ledPriceEl, text, previousLedPriceText, direction);
      previousLedPriceText = text;

      await new Promise(r => setTimeout(r, 1000));
    }
  }

  // LED paneli başlat
  ledMainLoop();

  // Portföy Fonksiyonları
  let portfolio = JSON.parse(localStorage.getItem('portfolio')) || {};
  let exchangeRates = { USD: 1, TRY: 1, EUR: 1, GBP: 1, JPY: 1, CNY: 1 };
  let currentCurrency = 'USD';
  
  function togglePortfolio() {
    const modal = document.getElementById('portfolioModal');
    modal.style.display = modal.style.display === 'block' ? 'none' : 'block';
    if(modal.style.display === 'block') initPortfolioModal();
  }

  function initPortfolioModal() {
    const select = document.getElementById('coinSelect');
    select.innerHTML = '<option value="" disabled selected>Coin Seç</option>';
    coinList.forEach(coin => {
      const option = document.createElement('option');
      option.value = coin;
      option.textContent = coin;
      select.appendChild(option);
    });
    updatePortfolioDisplay();
  }

  function addToPortfolio(e) {
    e.preventDefault();
    const coin = document.getElementById('coinSelect').value;
    const amount = parseFloat(document.getElementById('amountInput').value);
    
    portfolio[coin] = (portfolio[coin] || 0) + amount;
    localStorage.setItem('portfolio', JSON.stringify(portfolio));
    updatePortfolioDisplay();
    document.getElementById('amountInput').value = '';
  }

  function deletePortfolioItem(coin) {
    delete portfolio[coin];
    localStorage.setItem('portfolio', JSON.stringify(portfolio));
    updatePortfolioDisplay();
  }

  function updatePortfolioDisplay() {
    const list = document.getElementById('portfolioList');
    const totalElement = document.getElementById('portfolioTotal');
    const currencyElement = document.getElementById('portfolioCurrency');
    list.innerHTML = '';
    let total = 0;
    
    Object.entries(portfolio).forEach(([coin, amount]) => {
      const price = parseFloat(
        [...document.querySelectorAll('.coin-name a')]
          .find(a => a.textContent === coin)
          ?.closest('tr')
          .querySelector('td:nth-child(5)').textContent
      ) || 0;
      
      const item = document.createElement('div');
      item.className = 'portfolio-item';
      item.innerHTML = `
        <span>${coin}</span>
        <div class="portfolio-item-controls">
          <span>${amount} x ${price.toFixed(7)} ${currentCurrency} = ${(amount * price).toFixed(2)} ${currentCurrency}</span>
          <span class="delete-portfolio-item" onclick="deletePortfolioItem('${coin}')">×</span>
        </div>
      `;
      list.appendChild(item);
      total += amount * price;
    });
    
    totalElement.textContent = total.toFixed(2);
    currencyElement.textContent = currentCurrency;
  }

  // Döviz kuru güncelleme fonksiyonu
  function updateExchangeRates() {
    fetch('https://api.exchangerate-api.com/v4/latest/USD')
      .then(response => response.json())
      .then(data => {
        exchangeRates.TRY = data.rates.TRY || 32.0;
        exchangeRates.EUR = data.rates.EUR || 0.92;
        exchangeRates.GBP = data.rates.GBP || 0.79;
        exchangeRates.JPY = data.rates.JPY || 151.0;
        exchangeRates.CNY = data.rates.CNY || 7.23;
        updateCurrency();
      })
      .catch(error => {
        console.error('Döviz kuru alınırken hata:', error);
        // Varsayılan değerler (API çalışmazsa kullanılacak)
        exchangeRates.TRY = 32.0;
        exchangeRates.EUR = 0.92;
        exchangeRates.GBP = 0.79;
        exchangeRates.JPY = 151.0;
        exchangeRates.CNY = 7.23;
        updateCurrency();
      });
  }

  // Para birimi değiştirme fonksiyonu
  function updateCurrency() {
    currentCurrency = document.getElementById('currencySelect').value;
    const rate = exchangeRates[currentCurrency];
    
    document.querySelectorAll('#coinTable tbody tr').forEach(row => {
      const priceCell = row.cells[4];
      const originalPrice = parseFloat(priceCell.getAttribute('data-original-price')) || 0;
      const convertedPrice = originalPrice * rate;
      priceCell.textContent = formatNum(convertedPrice, 7);
    });
    
    if(document.getElementById('portfolioModal').style.display === 'block') {
      updatePortfolioDisplay();
    }
  }

  // Orijinal Scriptler
  let autoSortInterval = null;
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');
  const loadingContainer = document.getElementById('loadingContainer');
  let loadedCoins = 0;
  let favorites = JSON.parse(localStorage.getItem('favorites')) || {};

  // Yeni eklenen favori fonksiyonları
  function downloadFavorites() {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(favorites));
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", "favorites.json");
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
  }

  function uploadFavorites(input) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const newFavorites = JSON.parse(e.target.result);
        if (typeof newFavorites === 'object' && newFavorites !== null) {
          favorites = newFavorites;
          localStorage.setItem('favorites', JSON.stringify(favorites));
          
          // Tüm favori checkbox'larını güncelle
          document.querySelectorAll('.favorite-checkbox').forEach(checkbox => {
            const coinName = checkbox.getAttribute('onchange').split("'")[1];
            checkbox.checked = !!favorites[coinName];
          });
          
          applyAllFilters();
          alert('Favoriler başarıyla yüklendi!');
        } else {
          alert('Geçersiz dosya formatı!');
        }
      } catch (error) {
        alert('Dosya okunurken hata oluştu: ' + error.message);
      }
    };
    reader.readAsText(file);
    input.value = ''; // Aynı dosyayı tekrar yükleyebilmek için input'u sıfırla
  }

function updateProgress() {
    const totalCoins = coinList.length;
    const percent = Math.round((loadedCoins / totalCoins) * 100);
    progressBar.style.width = `${percent}%`;
    
    if(percent === 100) {
      setTimeout(() => {
        loadingContainer.style.opacity = '0';
        setTimeout(() => loadingContainer.style.display = 'none', 500);
      }, 1000);
    }
}

  function formatNum(val, decimals) {
    return val.toFixed(decimals).replace(/\.?(0)+$/, '');
  }

  let coinList = [];

async function loadCoinList() {
  try {
    const res = await fetch("https://api.binance.com/api/v3/exchangeInfo");
    const data = await res.json();
    
    // Sadece USDT ile biten semboller
    coinList = data.symbols
      .filter(s => s.symbol.endsWith("USDT") && s.status === "TRADING")
      .map(s => s.baseAsset);

    console.log("Toplam coin:", coinList.length);
    updateTable(); // tabloyu başlat
  } catch (e) {
    console.error("Coin listesi alınamadı:", e);
  }
}

loadCoinList();

  const tableBody = document.querySelector('#coinTable tbody');
  let sortDirection = Array(9).fill(true);
  const RSI_PERIOD = 14, RSI_HIST_DAILY = 1000, RSI_HIST_OTHER = 500;
  const rsiHistory = {};
  const previousPrices = {};

  function computeRSIFromArray(closes) {
    if (closes.length <= RSI_PERIOD) return NaN;
    let gain=0, loss=0;
    for (let i=1;i<=RSI_PERIOD;i++){const d=closes[i]-closes[i-1];gain+=d>0?d:0;loss+=d<0?-d:0;}
    let avgG=gain/RSI_PERIOD, avgL=loss/RSI_PERIOD;
    for (let i=RSI_PERIOD+1;i<closes.length;i++){const d=closes[i]-closes[i-1],g=d>0?d:0,l=d<0?-d:0;avgG=(avgG*(RSI_PERIOD-1)+g)/RSI_PERIOD;avgL=(avgL*(RSI_PERIOD-1)+l)/RSI_PERIOD;}
    if(avgL===0) return 100; const rs=avgG/avgL; return 100-(100/(1+rs));
  }

  function updateTable() {
    loadedCoins = 0;
    loadingContainer.style.display = 'block';
    loadingContainer.style.opacity = '1';
    updateProgress();
    updateExchangeRates();

    const months = parseInt(document.getElementById('dipMonths').value)||1;
    fetch('https://api.binance.com/api/v3/ticker/24hr').then(r=>r.json()).then(data=>{
      const map24 = new Map(data.map(d=>[d.symbol,d]));
      return Promise.all(coinList.map(name=>
        fetch(`https://api.binance.com/api/v3/klines?symbol=${name}USDT&interval=1M&limit=${months+1}`).then(r=>r.json()).then(klines=>{
          loadedCoins++;
          updateProgress();
          klines.pop(); const dipArr=klines.map(k=>+k[3]); const dip=dipArr.length?Math.min(...dipArr):NaN;
          const o=map24.get(name+'USDT')||{};
          return {name,dip,currentPrice:+o.lastPrice||NaN,priceChange:+o.priceChangePercent||NaN};
        })
      ));
    }).then(list=>{renderTable(list);setupWebSocket();});
  }

  function renderTable(list) {
    tableBody.innerHTML='';
    list.forEach((c,i)=>{
      const row=document.createElement('tr');
      row.innerHTML=`
        <td><input type="checkbox" class="favorite-checkbox" ${favorites[c.name]?'checked':''} onchange="toggleFavorite('${c.name}', this.checked)"></td>
        <td>${i+1}</td>
        <td class="coin-name">
          <a href="https://www.binance.com/en-TR/trade/${c.name}_USDT" target="_blank">${c.name}</a>
          <a href="https://tr.tradingview.com/chart/8tydse0K/?symbol=BINANCE%3A${c.name}USDT" target="_blank" class="chart-emoji">📈</a>
        </td>
        <td>${isNaN(c.dip)?'0':formatNum(c.dip,10)}</td>
        <td data-original-price="${isNaN(c.currentPrice)?'0':c.currentPrice}">${isNaN(c.currentPrice)?'0':formatNum(c.currentPrice * exchangeRates[currentCurrency],7)}</td>
        <td class="${c.dip&&((c.currentPrice-c.dip)/c.dip*100)>0?'green':'red'}">
          ${!isNaN(c.dip)?formatNum((c.currentPrice-c.dip)/c.dip*100,2)+'%':'0'}
        </td>
        <td class="${c.priceChange>0?'green':'red'}">
          ${isNaN(c.priceChange)?'0':formatNum(c.priceChange,2)+'%'}
        </td>
        <td class="a-rsi">…</td>
        <td class="h-rsi">…</td>
        <td class="g-rsi">…</td>
      `;
      tableBody.appendChild(row);
      initRSIHistory(c.name,'1M',row.querySelector('.a-rsi'));
      initRSIHistory(c.name,'1w',row.querySelector('.h-rsi'));
      initRSIHistory(c.name,'1d',row.querySelector('.g-rsi'));
    });
    applyAllFilters();
  }

  function toggleFavorite(name, isFavorite) {
    favorites[name] = isFavorite;
    localStorage.setItem('favorites', JSON.stringify(favorites));
    applyAllFilters();
  }

  function filterFavorites() {
    applyAllFilters();
  }

  function filterByDipMultiplier() {
    applyAllFilters();
  }

  function initRSIHistory(symbol,interval,cell){
    const lim=interval==='1d'?RSI_HIST_DAILY:RSI_HIST_OTHER;
    fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}USDT&interval=${interval}&limit=${lim}`)
      .then(r=>r.json()).then(klines=>{
        if(interval==='1d'){const last=klines.at(-1); if(Date.now()<last[0]+86400000) klines.pop();} else klines.pop();
        const closes=klines.map(k=>+k[4]);
        rsiHistory[symbol]=rsiHistory[symbol]||{}; rsiHistory[symbol][interval]=closes;
        const val=computeRSIFromArray(closes);
        cell.textContent=isNaN(val)?'0':formatNum(val,2);
        cell.classList.remove('green','red'); if(val>=70)cell.classList.add('green'); else if(val<=30)cell.classList.add('red');
      }).catch(_=>cell.textContent='0');
  }

  function setupWebSocket(){
    const ws=new WebSocket(`wss://stream.binance.com:9443/stream?streams=${coinList.map(n=>n.toLowerCase()+'usdt@ticker').join('/')}`);
    const rowMap={}; 
    tableBody.querySelectorAll('tr').forEach(r=>{
      const coinName = r.cells[2].querySelector('a').textContent;
      rowMap[coinName]=r;
    });
    
    ws.onmessage=e=>{
      const d=JSON.parse(e.data).data; 
      const nm=d.s.replace('USDT',''); 
      const row=rowMap[nm]; 
      if(!row)return;
      
      const price=+d.c;
      const oldPrice = previousPrices[nm] || 0;
      previousPrices[nm] = price;
      
      const priceCell = row.cells[4];
      priceCell.setAttribute('data-original-price', price);
      priceCell.textContent = formatNum(price * exchangeRates[currentCurrency], 7);
      priceCell.className = price > oldPrice ? 'green' : price < oldPrice ? 'red' : '';
      
      const change=+d.P;
      row.cells[6].textContent=formatNum(change,2)+'%'; 
      row.cells[6].className=change>=0?'green':'red';
      
      ['1M','1w','1d'].forEach((int,idx)=>{
        const hist=rsiHistory[nm]&&rsiHistory[nm][int]; 
        if(!hist) return;
        const arr=hist.slice(); 
        arr[arr.length-1]=price; 
        const val=computeRSIFromArray(arr);
        const cls=idx===0?'.a-rsi':idx===1?'.h-rsi':'.g-rsi'; 
        const cell=row.querySelector(cls);
        cell.textContent=isNaN(val)?'0':formatNum(val,2);
        cell.classList.remove('green','red'); 
        if(val>=70)cell.classList.add('green'); 
        else if(val<=30)cell.classList.add('red');
      });
    };
    ws.onclose=()=>setTimeout(setupWebSocket,5000);
  }

  function searchCoin(){
    const t=coinSearch.value.toLowerCase(); 
    tableBody.querySelectorAll('tr').forEach(r=>{
      const coinName = r.cells[2].querySelector('a').textContent.toLowerCase();
      r.style.display=coinName.includes(t)?'':'none';
      if(r.style.display !== 'none') applyOtherFilters(r);
    });
  }

  function applyOtherFilters(row) {
    const favoriteFilterEnabled = document.getElementById('favoriteFilter').checked;
    const coinName = row.cells[2].querySelector('a').textContent;
    
    if(favoriteFilterEnabled && !favorites[coinName]) {
      row.style.display = 'none';
      return;
    }
    
    const arsiFilterValue = document.getElementById('arsiFilter').value;
    const hrsiFilterValue = document.getElementById('hrsiFilter').value;
    const grsiFilterValue = document.getElementById('grsiFilter').value;
    const dipMultiplierValue = parseInt(document.getElementById('dipMultiplier').value);
    
    // A-RSI filtresi
    if(arsiFilterValue !== '0') {
      const arsiValue = parseFloat(row.cells[7].textContent);
      const [min, max] = arsiFilterValue.includes('+') ? 
        [parseInt(arsiFilterValue), 100] : 
        arsiFilterValue.split('-').map(Number);
      
      if(arsiValue < min || (max && arsiValue > max)) {
        row.style.display = 'none';
        return;
      }
    }
    
    // H-RSI filtresi
    if(hrsiFilterValue !== '0') {
      const hrsiValue = parseFloat(row.cells[8].textContent);
      const [min, max] = hrsiFilterValue.includes('+') ? 
        [parseInt(hrsiFilterValue), 100] : 
        hrsiFilterValue.split('-').map(Number);
      
      if(hrsiValue < min || (max && hrsiValue > max)) {
        row.style.display = 'none';
        return;
      }
    }
    
    // G-RSI filtresi
    if(grsiFilterValue !== '0') {
      const grsiValue = parseFloat(row.cells[9].textContent);
      const [min, max] = grsiFilterValue.includes('+') ? 
        [parseInt(grsiFilterValue), 100] : 
        grsiFilterValue.split('-').map(Number);
      
      if(grsiValue < min || (max && grsiValue > max)) {
        row.style.display = 'none';
        return;
      }
    }
    
    // Dipten artış filtresi
    if(dipMultiplierValue > 0) {
      const dipArtisCell = row.cells[5];
      const dipArtisValue = parseFloat(dipArtisCell.textContent);
      let minPercentage = 0, maxPercentage = 0;
      
      switch(dipMultiplierValue) {
        case 5: minPercentage = 0; maxPercentage = 500; break;
        case 10: minPercentage = 500; maxPercentage = 1000; break;
        case 20: minPercentage = 1000; maxPercentage = 2000; break;
        case 50: minPercentage = 2000; maxPercentage = 5000; break;
        case 200: minPercentage = 5000; maxPercentage = 20000; break;
        case 201: minPercentage = 20000; maxPercentage = Infinity; break;
      }
      
      const isValid = dipArtisValue > minPercentage && dipArtisValue <= maxPercentage;
      if(!isValid) row.style.display = 'none';
    }
  }

  function filterByRSI(type, value) {
    applyAllFilters();
  }

  function applyAllFilters() {
    const favoriteFilterEnabled = document.getElementById('favoriteFilter').checked;
    const searchTerm = document.getElementById('coinSearch').value.toLowerCase();
    const arsiFilterValue = document.getElementById('arsiFilter').value;
    const hrsiFilterValue = document.getElementById('hrsiFilter').value;
    const grsiFilterValue = document.getElementById('grsiFilter').value;
    const dipMultiplierValue = parseInt(document.getElementById('dipMultiplier').value);
    
    tableBody.querySelectorAll('tr').forEach(r => {
      const coinName = r.cells[2].querySelector('a').textContent;
      
      // Önce favori filtresini uygula
      if(favoriteFilterEnabled && !favorites[coinName]) {
        r.style.display = 'none';
        return;
      }
      
      // Arama filtresini uygula
      if(searchTerm && !coinName.toLowerCase().includes(searchTerm)) {
        r.style.display = 'none';
        return;
      }
      
      // Diğer filtreleri uygula
      let shouldShow = true;
      
      // A-RSI filtresi
      if(arsiFilterValue !== '0') {
        const arsiValue = parseFloat(r.cells[7].textContent);
        const [min, max] = arsiFilterValue.includes('+') ? 
          [parseInt(arsiFilterValue), 100] : 
          arsiFilterValue.split('-').map(Number);
        
        if(arsiValue < min || (max && arsiValue > max)) shouldShow = false;
      }
      
      // H-RSI filtresi
      if(hrsiFilterValue !== '0') {
        const hrsiValue = parseFloat(r.cells[8].textContent);
        const [min, max] = hrsiFilterValue.includes('+') ? 
          [parseInt(hrsiFilterValue), 100] : 
          hrsiFilterValue.split('-').map(Number);
        
        if(hrsiValue < min || (max && hrsiValue > max)) shouldShow = false;
      }
      
      // G-RSI filtresi
      if(grsiFilterValue !== '0') {
        const grsiValue = parseFloat(r.cells[9].textContent);
        const [min, max] = grsiFilterValue.includes('+') ? 
          [parseInt(grsiFilterValue), 100] : 
          grsiFilterValue.split('-').map(Number);
        
        if(grsiValue < min || (max && grsiValue > max)) shouldShow = false;
      }
      
      // Dipten artış filtresi
      if(dipMultiplierValue > 0) {
        const dipArtisCell = r.cells[5];
        const dipArtisValue = parseFloat(dipArtisCell.textContent);
        let minPercentage = 0, maxPercentage = 0;
        
        switch(dipMultiplierValue) {
          case 5: minPercentage = 0; maxPercentage = 500; break;
          case 10: minPercentage = 500; maxPercentage = 1000; break;
          case 20: minPercentage = 1000; maxPercentage = 2000; break;
          case 50: minPercentage = 2000; maxPercentage = 5000; break;
          case 200: minPercentage = 5000; maxPercentage = 20000; break;
          case 201: minPercentage = 20000; maxPercentage = Infinity; break;
        }
        
        const isValid = dipArtisValue > minPercentage && dipArtisValue <= maxPercentage;
        if(!isValid) shouldShow = false;
      }
      
      r.style.display = shouldShow ? '' : 'none';
    });
  }

  function sortTable(col){
    const rows=Array.from(tableBody.querySelectorAll('tr'));
    
    if(col === 6 && autoSortCheckbox.checked){
      sortDirection[col] = false;
    }
    
    const dir=sortDirection[col]?1:-1;
    rows.sort((a,b)=>{
      let x=a.cells[col].textContent.trim();
      let y=b.cells[col].textContent.trim();
      
      if(col === 2) {
        return x.localeCompare(y, 'en', {numeric: true}) * dir;
      }
      
      if(col >= 3) {
        x=parseFloat(x)||0;
        y=parseFloat(y)||0;
        return x>y?dir:x<y?-dir:0;
      }
      
      return 0;
    });
    
    rows.forEach((r,i)=>{
      r.cells[1].textContent=i+1;
      tableBody.appendChild(r);
    });
    sortDirection[col]=!sortDirection[col];
  }

  autoSortCheckbox.addEventListener('change', function() {
    if(this.checked) {
      autoSortInterval = setInterval(() => sortTable(6), 1000);
    } else {
      clearInterval(autoSortInterval);
      autoSortInterval = null;
    }
  });

  updateTable();
</script>

</body>
</html>
